#!/usr/bin/env ruby

require 'optparse'
require 'ostruct'

$LOAD_PATH.unshift(File.join(File.dirname(__FILE__), '..', 'lib'))
require 'code_generator'
require 'parser'

options = OpenStruct.new
options.swift = false
options.java = false
options.jni_h = false
options.jni_c = false

OptionParser.new do |opts|
  opts.banner = 'Usage: codegen [options] <input folder>'

  opts.on('-s', '--swift', 'Generate Swift code') do |v|
    options.swift = v
  end
  opts.on('-j', '--java', 'Generate Java code') do |v|
    options.java = v
  end
  opts.on('-h', '--jnih', 'Generate JNI header') do |v|
    options.jni_h = v
  end
  opts.on('-c', '--jnic', 'Generate JNI code') do |v|
    options.jni_c = v
  end
end.parse!

if ARGV.empty?
  STDERR.puts 'Please specify input directory'
  exit 1
end

Dir.foreach(ARGV[0]) do |item|
  next if ['.', '..'].include?(item)
  entity = Parser.new(path: File.expand_path(File.join(ARGV[0], item))).parse
  if entity.nil?
    STDERR.puts "Failed to parse #{item}"
    next
  end

  if options.swift
    code = CodeGenerator.new(entity: entity).render_swift
    puts code
  elsif options.java
    code = CodeGenerator.new(entity: entity).render_java
    puts code
  elsif options.jni_h
    code = CodeGenerator.new(entity: entity).render_jni_h
    puts code
  elsif options.jni_c
    code = CodeGenerator.new(entity: entity).render_jni_c
    puts code
  end
end
